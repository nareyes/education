{
	"name": "create_views_raw",
	"properties": {
		"folder": {
			"name": "dw_serverless"
		},
		"content": {
			"query": "USE NYC_Taxi_Serverless\nGO\n\n-- Rate Code (JSON Source)\nDROP VIEW IF EXISTS Raw.View_RateCode\nGO\n\nCREATE VIEW Raw.View_RateCode\nAS\n    SELECT\n        RateCodeID\n        ,RateCodeDescription\n    FROM\n        OPENROWSET (\n            BULK 'rate_code.json',\n            DATA_SOURCE = 'NYC_Taxi_Raw',\n            FORMAT = 'CSV', -- Even for JSON\n            PARSER_VERSION = '1.0',\n            FIELDTERMINATOR = '0x0b',\n            FIELDQUOTE = '0x0b',\n            ROWTERMINATOR = '0x0b' -- Vertical Tab\n        ) \n\n            WITH (\n                jsonDoc NVARCHAR(MAX)\n            ) AS RateCode\n\n    CROSS APPLY OPENJSON(jsonDoc) -- Return Key Value Pairs\n        WITH (\n            RateCodeID              TINYINT     '$.rate_code_id'\n            ,RateCodeDescription    VARCHAR(20) '$.rate_code'\n        );\nGO\n\nSELECT * FROM Raw.View_RateCode;\nGO\n\n\n-- Payment Type\nDROP VIEW IF EXISTS Raw.View_PaymentType\nGO\n\nCREATE VIEW Raw.View_PaymentType\nAS\n    SELECT\n        PaymentType\n        ,PaymentTypeDescription\n    FROM\n        OPENROWSET (\n            BULK 'payment_type.json'\n            ,DATA_SOURCE = 'NYC_Taxi_Raw'\n            ,FORMAT = 'CSV' -- Even for JSON\n            ,PARSER_VERSION = '1.0'\n            ,FIELDTERMINATOR = '0x0b'\n            ,FIELDQUOTE = '0x0b'\n            ,ROWTERMINATOR = '0x0a'\n        ) \n\n            WITH (\n                jsonDoc NVARCHAR(MAX)\n            ) AS PaymentType\n\n    CROSS APPLY OPENJSON(jsonDoc) -- Return Key Value Pairs\n        WITH (\n            PaymentType             SMALLINT    '$.payment_type'\n            ,PaymentTypeDescription VARCHAR(15) '$.payment_type_desc'\n        )\nGO\n\nSELECT * FROM Raw.View_PaymentType;\nGO\n\n\n-- Partition Pruning for Views (Workaround for External Table Pruning)\n-- External Tables Do Not Support Partition Pruning\nDROP VIEW IF EXISTS Raw.View_TripCSV\nGO\n\nCREATE VIEW Raw.View_TripCSV\nAS\n    SELECT\n        TripCSV.filepath(1) AS PartitionYear\n        ,TripCSV.filepath(2) AS PartitionMonth\n        ,TripCSV.*\n    FROM\n        OPENROWSET (\n            BULK 'trip_data_green_csv/year=*/month=*/*.csv'\n            ,DATA_SOURCE = 'NYC_Taxi_Raw'\n            ,FORMAT = 'CSV'\n            ,PARSER_VERSION = '2.0'\n            ,HEADER_ROW = TRUE\n        )\n\n            WITH (\n                VendorID\t            TINYINT\n                ,lpep_pickup_datetime\tDATETIME2(0) 2\n                ,lpep_dropoff_datetime\tDATETIME2(0)\n                ,store_and_fwd_flag\t    VARCHAR(10)\n                ,RatecodeID\t            SMALLINT\n                ,PULocationID\t        SMALLINT\n                ,DOLocationID\t        SMALLINT\n                ,passenger_count\t    TINYINT\n                ,trip_distance\t        FLOAT\n                ,fare_amount\t        FLOAT\n                ,extra\t                FLOAT\n                ,mta_tax\t            FLOAT\n                ,tip_amount\t            FLOAT\n                ,tolls_amount\t        FLOAT\n                ,ehail_fee\t            VARCHAR(50)\n                ,improvement_surcharge  FLOAT\n                ,total_amount\t        FLOAT\n                ,payment_type\t        BIGINT\n                ,trip_type              BIGINT\n                ,congestion_surcharge   FLOAT\n            ) AS TripCSV\nGO\n\nSELECT TOP 10 * FROM Raw.View_TripCSV;\n\nSELECT\n    PartitionYear\n    ,PartitionMonth\n    ,COUNT(1) AS RecordCount\nFROM Raw.View_TripCSV\nWHERE PartitionYear = 2020\nGROUP BY PartitionYear,PartitionMonth\nORDER BY PartitionMonth;\nGO",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "NYC_Taxi_Serverless",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}
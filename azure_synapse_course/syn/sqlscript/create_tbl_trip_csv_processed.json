{
	"name": "create_tbl_trip_csv_processed",
	"properties": {
		"description": "Partitioned Data",
		"folder": {
			"name": "dw_serverless/create_external_objects_processed"
		},
		"content": {
			"query": "USE NYC_Taxi_Serverless\nGO\n\n-- Data Written to ADLS Cannot be Deleted Here\n-- Delete via Pipelines and Call Script as a Best Practice\n\n-- Taxi Trip\nIF OBJECT_ID ('Processed.Trip') IS NOT NULL\n    DROP EXTERNAL TABLE Processed.Trip\n    GO\n\nCREATE EXTERNAL TABLE Processed.Trip\n\n    WITH (\n        LOCATION = 'trip'\n        ,DATA_SOURCE = NYC_Taxi_Processed\n        ,FILE_FORMAT = Parquet_File_Format\n    )\n\nAS\n\n    -- SELECT *\n    -- FROM Raw.TripCSV;\n\n    -- Alternate: Use OPENROWSET if Raw Table Does Not Exists\n    -- Preferred Method, Simple Column Renaming\n    -- Issue w/ Partitioned Data: This Will Not Maintain Partitions (Added ParitionYear and PartitionMonth for Simple Parition-Like Filtering)\n    -- Reference create_sp_partition_trip_data for Stored Procedure Workaround (Using Spark Pool is a Preferred Solution)\n    SELECT\n        Trip.filepath(1) AS PartitionYear\n        ,Trip.filepath(2) AS PartitionMonth\n        ,Trip.*\n    FROM\n        OPENROWSET (\n            BULK 'trip_data_green_csv/year=*/month=*/*.csv'\n            ,DATA_SOURCE = 'NYC_Taxi_Raw'\n            ,FORMAT = 'CSV'\n            ,PARSER_VERSION = '2.0'\n            ,HEADER_ROW = TRUE\n        ) \n\n        WITH (\n            VendorID\t            TINYINT         1\n            ,PickupDateTime     \tDATETIME2(0)    2\n            ,DropoffDateTime    \tDATETIME2(0)    3\n            ,StoreFwdFlag   \t    VARCHAR(10)     4\n            ,RateCodeID\t            SMALLINT        5\n            ,PULocationID\t        SMALLINT        6\n            ,DOLocationID\t        SMALLINT        7\n            ,PassengerCount \t    TINYINT         8\n            ,TripDistance\t        FLOAT           9\n            ,FareAmount \t        FLOAT           10\n            ,Extra\t                FLOAT           11\n            ,MTATax \t            FLOAT           12\n            ,TipAmount\t            FLOAT           13\n            ,TollsAmount\t        FLOAT           14\n            ,eHailFee\t            VARCHAR(50)     15\n            ,ImprovementSurcharge   FLOAT           16\n            ,TotalAmount\t        FLOAT           17\n            ,PaymentType\t        BIGINT          18\n            ,TripType               BIGINT          19\n            ,CongestionSurcharge    FLOAT           20\n        ) AS Trip\n\n\n-- Query Processed Table\nSELECT TOP 10 * FROM Processed.Trip\nWHERE PartitionYear = 2020 AND PartitionMonth = 01;\n\n\n-- Run Stored Procedure to Load Partitioned Data\n-- Again, This is Not an Optimal Solution. It's a Workaround\nEXEC Processed.InsertPartitionTripData @PartitionYear = '2020', @PartitionMonth = '01';\nEXEC Processed.InsertPartitionTripData @PartitionYear = '2020', @PartitionMonth = '02';\nEXEC Processed.InsertPartitionTripData @PartitionYear = '2020', @PartitionMonth = '03';\nEXEC Processed.InsertPartitionTripData @PartitionYear = '2020', @PartitionMonth = '04';\nEXEC Processed.InsertPartitionTripData @PartitionYear = '2020', @PartitionMonth = '05';\nEXEC Processed.InsertPartitionTripData @PartitionYear = '2020', @PartitionMonth = '06';\nEXEC Processed.InsertPartitionTripData @PartitionYear = '2020', @PartitionMonth = '07';\nEXEC Processed.InsertPartitionTripData @PartitionYear = '2020', @PartitionMonth = '08';\nEXEC Processed.InsertPartitionTripData @PartitionYear = '2020', @PartitionMonth = '09';\nEXEC Processed.InsertPartitionTripData @PartitionYear = '2020', @PartitionMonth = '10';\nEXEC Processed.InsertPartitionTripData @PartitionYear = '2020', @PartitionMonth = '11';\nEXEC Processed.InsertPartitionTripData @PartitionYear = '2020', @PartitionMonth = '12';\nEXEC Processed.InsertPartitionTripData @PartitionYear = '2021', @PartitionMonth = '01';\nEXEC Processed.InsertPartitionTripData @PartitionYear = '2021', @PartitionMonth = '02';\nEXEC Processed.InsertPartitionTripData @PartitionYear = '2021', @PartitionMonth = '03';\nEXEC Processed.InsertPartitionTripData @PartitionYear = '2021', @PartitionMonth = '04';\nEXEC Processed.InsertPartitionTripData @PartitionYear = '2021', @PartitionMonth = '05';\nEXEC Processed.InsertPartitionTripData @PartitionYear = '2021', @PartitionMonth = '06';\nEXEC Processed.InsertPartitionTripData @PartitionYear = '2021', @PartitionMonth = '07';",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "NYC_Taxi_Serverless",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}